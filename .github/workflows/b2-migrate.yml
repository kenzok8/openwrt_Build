name: B2 Migrate Files

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET: ${{ secrets.B2_BUCKET }}
      OLD_PREFIX: op-dllkids-xyz-archive/dllkids.xyz

    steps:
      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [b2]
          type = b2
          account = ${{ env.B2_KEY_ID }}
          key = ${{ env.B2_APPLICATION_KEY }}
          hard_delete = true
          EOF

      - name: Copy firmware to bucket root
        run: |
          echo ">>> Copying op/firmware/ ..."
          rclone copy "b2:${{ env.B2_BUCKET }}/${{ env.OLD_PREFIX }}/op/firmware/" \
                      "b2:${{ env.B2_BUCKET }}/op/firmware/" \
                      --fast-list \
                      --transfers 8 \
                      --checkers 16 \
                      --progress

      - name: Copy packages to bucket root
        run: |
          echo ">>> Copying packages/ ..."
          rclone copy "b2:${{ env.B2_BUCKET }}/${{ env.OLD_PREFIX }}/packages/" \
                      "b2:${{ env.B2_BUCKET }}/packages/" \
                      --fast-list \
                      --transfers 8 \
                      --checkers 16 \
                      --progress

      - name: Verify new paths
        run: |
          echo "=== op/firmware/ ==="
          rclone lsd "b2:${{ env.B2_BUCKET }}/op/firmware/"
          echo "=== packages/ ==="
          rclone lsd "b2:${{ env.B2_BUCKET }}/packages/"

      - name: Delete old path
        run: |
          echo ">>> Deleting old prefix: ${{ env.OLD_PREFIX }} ..."
          rclone purge "b2:${{ env.B2_BUCKET }}/${{ env.OLD_PREFIX }}/" --fast-list
          echo "Done. Old path deleted."

name: immortalwrt_R2s_new

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "ssh"
        required: false
        default: "false"

env:
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: æ„å»ºå›ºä»¶ - ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: [immortalwrt_r2s]

    steps:
      - name: ğŸ§¾ æ‹‰å–ä»£ç 
        uses: actions/checkout@main

      - name: ğŸ§± åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆæ¸…ç†ç©ºé—´ + å®‰è£…ä¾èµ–ï¼‰
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ§¹ æ¸…ç†é¢„è£…åŒ…é‡Šæ”¾ç©ºé—´..."
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android \
                      /opt/hostedtoolcache /usr/lib/jvm \
                      "$AGENT_TOOLSDIRECTORY" /usr/local/share/boost
          sudo apt-get purge -y "mono*" "php*" || true
          sudo apt-get autoremove -y
          sudo apt-get clean

          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo -E apt-get update
          sudo -E apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison \
            build-essential bzip2 ccache cmake cpio curl device-tree-compiler \
            fastjar flex gawk gettext gcc-multilib g++-multilib git gperf \
            haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full \
            patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo \
            uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev rename
          sudo timedatectl set-timezone "$TZ"

      - name: ğŸ“… è·å–å½“å‰æ—¶é—´
        id: date
        run: |
          echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "date2=$(date +'%m/%d %Y')"   >> $GITHUB_ENV
          echo "date3=$(date +'%m.%d')"      >> $GITHUB_ENV
          echo "VERSION=$(date +'%m.%d')"    >> $GITHUB_ENV

      - name: ğŸ“¦ å…‹éš†æºä»£ç 
        env:
          REPO_URL: https://github.com/immortalwrt/immortalwrt
          REPO_BRANCH: openwrt-24.10
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: ğŸ”„ æ›´æ–°Feeds
        working-directory: ./openwrt
        run: |
          echo "ğŸ“¦ å…‹éš†è‡ªå®šä¹‰åŒ…ä»“åº“..."
          git clone --depth 1 https://github.com/gdy666/luci-app-lucky.git package/lucky || {
            echo "âŒ lucky ä»“åº“å…‹éš†å¤±è´¥"
            exit 1
          }
          git clone --depth 1 https://github.com/nikkinikki-org/OpenWrt-nikki.git package/nikki || {
            echo "âš ï¸ nikki ä»“åº“å…‹éš†å¤±è´¥ï¼Œè·³è¿‡è¯¥åŒ…"
            rm -rf package/nikki
          }

          echo "ğŸ”„ æ›´æ–°è½¯ä»¶æº..."
          ./scripts/feeds update -a

          echo "ğŸ“¦ å®‰è£…è½¯ä»¶åŒ…..."
          ./scripts/feeds install -a

      - name: ğŸ›  ä¿®æ”¹é»˜è®¤é…ç½®
        working-directory: ./openwrt
        run: |
          sed -i 's/192.168.1.1/192.168.3.1/g' package/base-files/files/bin/config_generate
          sed -i 's/ImmortalWrt/SS-Wrt/g'      package/base-files/files/bin/config_generate

      - name: âš™ï¸ åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          CONFIG_FILE="${{ matrix.target }}.config"
          if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… å‘ç°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            cp "$CONFIG_FILE" openwrt/.config
          else
            echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            exit 1
          fi

      - name: ğŸ“‹ åŒæ­¥é…ç½®ï¼ˆmake oldconfigï¼‰
        working-directory: ./openwrt
        run: |
          # å¯¹æ¯”æºç æ›´æ–°ï¼Œéäº¤äº’åœ°æ¥å—é»˜è®¤
          yes "" | make oldconfig
          echo "ğŸ“‚ æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
          head -n 20 .config

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        working-directory: ./openwrt
        run: |
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: ğŸ§© ç¼–è¯‘å›ºä»¶
        working-directory: ./openwrt
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼ˆ$(nproc) æ ¸å¿ƒçº¿ç¨‹ï¼‰..."
          echo "ğŸ’¡ é¦–æ¬¡ç¼–è¯‘å°è¯•ï¼ˆå¹¶è¡Œæ„å»ºï¼‰..."
          make -j$(nproc) || {
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼..."
            echo "ğŸ“‹ å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—..."
            make -j1 V=s
          }

      - name: ğŸ“‚ æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir -p firmware
          mv -f openwrt/bin/targets/*/*/{*combined*,*sysupgrade*} ./firmware/ 2>/dev/null || true
          cp openwrt/.config ./firmware/${{ matrix.target }}.config
          echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV

      - name: â˜ï¸ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ${{ env.date3 }} _${{ matrix.target }}
          path: ${{ env.FIRMWARE }}

      - name: ğŸ· ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "OpenWrt firmware for ${{ matrix.target }}" > release.txt
          echo "Build date: ${{ env.date2 }}"          >> release.txt
          echo "status=success"                        >> $GITHUB_OUTPUT

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          files: "${{ env.FIRMWARE }}/*"
          name: ${{ env.date2 }} ${{ matrix.target }}
          tag_name: ${{ env.date }}_${{ matrix.target }}
          body_path: release.txt

      - name: ğŸ§¹ æ„å»ºå®Œæˆåæ¸…ç†ç©ºé—´
        if: always()
        run: |
          echo "ğŸ—‘ æ¸…ç†æ„å»ºä¸­é—´æ–‡ä»¶é‡Šæ”¾ç£ç›˜..."
          rm -rf openwrt/build_dir openwrt/staging_dir openwrt/tmp
          df -h

      - name: ğŸ§¹ åˆ é™¤æ—§çš„ Workflow è®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 0

      - name: ğŸ—‘ æ¸…ç†æ—§çš„ Release
        uses: dev-drprasad/delete-older-releases@v0.3.0
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 6
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
